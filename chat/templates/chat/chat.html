{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ active_room.name }}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* --- å·¦ä¾§ä¾§è¾¹æ  --- */
        .sidebar {
            width: 280px; background: #f5f7fa; border-right: 1px solid #ddd;
            display: flex; flex-direction: column;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid #ddd; }
        .search-box {
            width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc;
            outline: none; background: white;
        }

        .room-list { flex: 1; overflow-y: auto; }

        .room-item {
            padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer;
            transition: background 0.2s; color: #333; text-decoration: none; display: block;
        }
        .room-item:hover { background: #e6e9ef; }

        /* é€‰ä¸­çŠ¶æ€ï¼šè“è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­— */
        .room-item.active { background: #0088cc; color: white; }
        .room-item.active .room-last-msg { color: #e0e0e0; }

        .room-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .room-last-msg { font-size: 13px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}

        /* --- å³ä¾§èŠå¤©ä¸»åŒºåŸŸ --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; }

        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: white; z-index: 10;
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-info { font-size: 14px; color: #888; }
        .back-to-lobby { text-decoration: none; color: #0088cc; font-size: 14px; }

        /* æ¶ˆæ¯åˆ—è¡¨åŒº */
        .messages-box {
            flex: 1; padding: 20px; overflow-y: auto; background: #fff;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
        .message-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .message-info { font-size: 12px; color: #999; margin-bottom: 4px; }
        .message-bubble {
            padding: 10px 15px; border-radius: 10px; font-size: 15px; line-height: 1.5;
            position: relative; word-wrap: break-word;
            border: 2px solid #000; /* ä½ çš„è®¾è®¡å›¾é£æ ¼ï¼šé»‘è‰²è¾¹æ¡† */
        }
        .message-time { font-size: 11px; color: #aaa; text-align: right; margin-top: 5px; }

        /* åˆ«äººçš„æ¶ˆæ¯ (å·¦ä¾§) */
        .message-left { align-self: flex-start; }
        .message-left .message-bubble {
            background: white; color: #333;
            border-top-left-radius: 0; /* æ°”æ³¡å°–è§’ */
        }

        /* æˆ‘çš„æ¶ˆæ¯ (å³ä¾§) */
        .message-right { align-self: flex-end; align-items: flex-end; }
        .message-right .message-bubble {
            background: #00a8ff; color: white; /* ä½ çš„è®¾è®¡å›¾ï¼šè“è‰²èƒŒæ™¯ */
            border-top-right-radius: 0;
            border: 2px solid #000;
        }
        .message-right .message-info { text-align: right; display: none; /* è‡ªå·±å‘çš„æ¶ˆæ¯é€šå¸¸ä¸æ˜¾ç¤ºåå­— */ }

        /* --- åº•éƒ¨è¾“å…¥åŒº --- */
        .input-area {
            padding: 20px; border-top: 1px solid #eee; background: #f9f9f9;
            display: flex; align-items: center; gap: 10px;
        }
        .attach-btn { font-size: 24px; cursor: pointer; color: #666; }

        .msg-input {
            flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc;
            outline: none; font-size: 16px;
        }

        .send-btn {
            padding: 10px 25px; background: #00a8ff; color: white;
            border: 2px solid #000; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        .send-btn:hover { background: #0088cc; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <input type="text" class="search-box" placeholder="æœç´¢...">
        </div>

        <div class="room-list">
            {% for room in joined_rooms %}
            <a href="{% url 'chat_room' room.name %}"
               class="room-item {% if room.name == active_room.name %}active{% endif %}">
                <div class="room-name">{{ room.name }}</div>
                <div class="room-last-msg">
                    {% if room.messages.last %}
                        {{ room.messages.last.sender.username }}: {{ room.messages.last.content }}
                    {% else %}
                        æš‚æ— æ¶ˆæ¯
                    {% endif %}
                </div>
            </a>
            {% endfor %}

            <a href="{% url 'lobby' %}" class="room-item" style="color:#0088cc; text-align:center;">
                + æ·»åŠ /åˆ›å»ºæ–°èŠå¤©å®¤
            </a>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div>
                <span class="header-title">{{ active_room.name }}</span>
                <span class="header-info">({{ active_room.members.count }} æˆå‘˜)</span>
            </div>
            <a href="{% url 'lobby' %}" class="back-to-lobby">è¿”å›å¤§å…</a>
        </div>

        <div class="messages-box" id="msgBox">
            {% if has_more %}
                <div id="historyBtn" class="history-btn" onclick="loadHistory()">
                    â–² ç‚¹å‡»åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
                </div>
            {% endif %}

            {% for msg in messages %}
                {% if msg.sender == user %}
                    <div class="message-wrapper message-right" data-msg-id="{{ msg.id }}">
                        <div class="message-bubble">
                            {% if msg.file %}
                                {% if msg.file.name|lower|slice:"-3:" == "jpg" or msg.file.name|lower|slice:"-3:" == "png" or msg.file.name|lower|slice:"-4:" == "jpeg" or msg.file.name|lower|slice:"-3:" == "gif" %}
                                    <img src="{{ msg.file.url }}" style="max-width: 200px; max-height: 200px; border-radius: 5px; margin-bottom: 5px; display:block; cursor:pointer;" onclick="window.open(this.src)">
                                {% else %}
                                    <div style="background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px;">
                                        ğŸ“ <a href="{{ msg.file.url }}" target="_blank" style="text-decoration:none; color:#333;">ä¸‹è½½æ–‡ä»¶</a>
                                    </div>
                                {% endif %}
                            {% endif %}

                            {% if msg.content %}
                                <div>{{ msg.content }}</div>
                            {% endif %}
                        </div>
                        <div class="message-time">{{ msg.timestamp|date:"H:i" }}</div>
                    </div>
                {% else %}
                    <div class="message-wrapper message-left" data-msg-id="{{ msg.id }}">
                        <div class="message-info">{{ msg.sender.username }}</div>
                        <div class="message-bubble">
                            {% if msg.file %}
                                {% if msg.file.name|lower|slice:"-3:" == "jpg" or msg.file.name|lower|slice:"-3:" == "png" or msg.file.name|lower|slice:"-4:" == "jpeg" %}
                                    <img src="{{ msg.file.url }}" style="max-width: 200px; max-height: 200px; border-radius: 5px; margin-bottom: 5px; display:block; cursor:pointer;" onclick="window.open(this.src)">
                                {% else %}
                                    <div style="background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px;">
                                        ğŸ“ <a href="{{ msg.file.url }}" target="_blank" style="text-decoration:none; color:#333;">ä¸‹è½½æ–‡ä»¶</a>
                                    </div>
                                {% endif %}
                            {% endif %}

                            {% if msg.content %}
                                <div>{{ msg.content }}</div>
                            {% endif %}
                        </div>
                        <div class="message-time">{{ msg.timestamp|date:"H:i" }}</div>
                    </div>
                {% endif %}
                {% endfor %}
        </div>

        <div class="input-area">
            <input type="file" id="fileInput" style="display: none;">

            <div class="attach-btn" onclick="document.getElementById('fileInput').click()">ğŸ“</div>

            <input type="text" class="msg-input" id="inputMsg" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

<script>
        // ================== 1. åŸºç¡€å˜é‡ä¸åˆå§‹åŒ– ==================
        const msgBox = document.getElementById('msgBox');
        const inputMsg = document.getElementById('inputMsg');
        const sendBtn = document.querySelector('.send-btn');
        const roomId = "{{ active_room.id }}";
        const csrfToken = "{{ csrf_token }}"; // å•ç‹¬æå– CSRF token æ–¹ä¾¿ä½¿ç”¨

        // è·å–é¡µé¢ä¸Šå·²ç»å­˜åœ¨çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„ID
        let lastMessageId = parseInt("{{ last_id|default:0 }}");

        // æ ‡è®°ä½ï¼šæ˜¯å¦æ­£åœ¨è·å–æ¶ˆæ¯
        let isFetching = false;

        // è‡ªåŠ¨æ»šåˆ°åº•éƒ¨
        function scrollToBottom() { msgBox.scrollTop = msgBox.scrollHeight; }
        // é¡µé¢åŠ è½½å®Œæ»šåˆ°åº•éƒ¨
        scrollToBottom();

        // è¾…åŠ©å‡½æ•°ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºå›¾ç‰‡
        function isImage(url) {
            if (!url) return false;
            const extension = url.split('.').pop().toLowerCase();
            return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(extension);
        }

        // ================== 2. è½®è¯¢ä¼˜åŒ– ==================
        setInterval(fetchNewMessages, 2000);

        function fetchNewMessages() {
            if (isFetching) return;
            isFetching = true;

            fetch(`/api/get_messages/?room_id=${roomId}&last_message_id=${lastMessageId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    let hasNew = false;
                    // å¼ºåˆ¶æŒ‰ ID æ’åº
                    data.messages
                        .sort((a, b) => a.id - b.id)
                        .forEach(msg => {
                            if (appendMessage(msg)) {
                                hasNew = true;
                                if (msg.id > lastMessageId) {
                                    lastMessageId = msg.id;
                                }
                            }
                        });
                    if (hasNew) scrollToBottom();
                }
            })
            .catch(err => console.error("è½®è¯¢å‡ºé”™:", err))
            .finally(() => {
                isFetching = false;
            });
        }

        // ================== 3. æ¸²æŸ“æ¶ˆæ¯å‡½æ•° (æ•´åˆç‰ˆ) ==================
        function appendMessage(msg) {
            // æ ¸å¿ƒå»é‡ï¼šå¦‚æœé¡µé¢ä¸Šå·²ç»æœ‰è¿™ä¸ªIDçš„æ¶ˆæ¯ï¼Œç›´æ¥å¿½ç•¥
            if (document.querySelector(`.message-wrapper[data-msg-id="${msg.id}"]`)) {
                return false;
            }

            // 1. ç”Ÿæˆå†…å®¹ HTML (å›¾ç‰‡/æ–‡ä»¶/æ–‡å­—)
            let contentHtml = '';

            // å¦‚æœæœ‰æ–‡ä»¶
            if (msg.file_url) {
                if (isImage(msg.file_url)) {
                    // æ˜¯å›¾ç‰‡ï¼šæ˜¾ç¤ºç¼©ç•¥å›¾
                    contentHtml += `<img src="${msg.file_url}" style="max-width: 200px; max-height: 200px; border-radius: 5px; margin-bottom: 5px; display:block; cursor:pointer;" onclick="window.open(this.src)">`;
                } else {
                    // æ˜¯æ–‡ä»¶ï¼šæ˜¾ç¤ºä¸‹è½½é“¾æ¥
                    contentHtml += `<div style="background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px;">
                                        ğŸ“ <a href="${msg.file_url}" target="_blank" style="text-decoration:none; color:#333;">${msg.file_name || 'ä¸‹è½½æ–‡ä»¶'}</a>
                                    </div>`;
                }
            }

            // å¦‚æœæœ‰æ–‡å­—
            if (msg.content) {
                contentHtml += `<div>${msg.content}</div>`;
            }

            let html = '';
            if (msg.is_my_msg) {
                html = `
                    <div class="message-wrapper message-right" data-msg-id="${msg.id}">
                        <div class="message-bubble">${contentHtml}</div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>`;
            } else {
                html = `
                    <div class="message-wrapper message-left" data-msg-id="${msg.id}">
                        <div class="message-info">${msg.sender}</div>
                        <div class="message-bubble">${contentHtml}</div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>`;
            }
            // æ’å…¥åˆ°åˆ—è¡¨æœ«å°¾
            msgBox.insertAdjacentHTML('beforeend', html);
            return true;
        }

        // ================== 4. å‘é€æ¶ˆæ¯é€»è¾‘ ==================
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            const content = inputMsg.value.trim();
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!content && !file) return;

            sendBtn.disabled = true;
            sendBtn.innerText = 'å‘é€ä¸­...';
            inputMsg.disabled = true;

            const formData = new FormData();
            formData.append('room_id', roomId);
            formData.append('content', content);
            if (file) {
                formData.append('file', file);
            }

            fetch('{% url "send_message" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    inputMsg.value = '';
                    fileInput.value = '';
                    fetchNewMessages(); // ç«‹å³æ‹‰å–æ–°æ¶ˆæ¯
                } else {
                    alert('å‘é€å¤±è´¥: ' + data.error);
                }
            })
            .catch(err => {
                console.error(err);
                alert('ç½‘ç»œé”™è¯¯');
            })
            .finally(() => {
                sendBtn.disabled = false;
                sendBtn.innerText = 'å‘é€';
                inputMsg.disabled = false;
                inputMsg.focus();
            });
        }

        // ================== 5. åŠ è½½å†å²è®°å½• (å·²ä¿®å¤) ==================
        function loadHistory() {
            const firstMsgEl = document.querySelector('.message-wrapper');
            if (!firstMsgEl) return;

            // ä¿®å¤ç‚¹ï¼šè¿™é‡Œåªå£°æ˜ä¸€æ¬¡
            const firstId = firstMsgEl.getAttribute('data-msg-id');
            const btn = document.getElementById('historyBtn');

            if(!btn) return; // å®‰å…¨æ£€æŸ¥

            const originalText = btn.innerText;
            btn.innerText = 'åŠ è½½ä¸­...';
            btn.style.pointerEvents = 'none';

            fetch(`/api/get_history/?room_id=${roomId}&first_msg_id=${firstId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.messages.length > 0) {
                        const sortedMessages = data.messages.sort((a, b) => a.id - b.id);
                        let html = '';

                        sortedMessages.forEach(msg => {
                            if (document.querySelector(`.message-wrapper[data-msg-id="${msg.id}"]`)) return;

                            // === æ„å»ºå†…å®¹ HTML (å¤ç”¨é€»è¾‘) ===
                            let contentHtml = '';
                            if (msg.file_url) {
                                if (isImage(msg.file_url)) {
                                    contentHtml += `<img src="${msg.file_url}" style="max-width: 200px; max-height: 200px; border-radius: 5px; margin-bottom: 5px; display:block; cursor:pointer;" onclick="window.open(this.src)">`;
                                } else {
                                    contentHtml += `<div style="background: #eee; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px;">
                                        ğŸ“ <a href="${msg.file_url}" target="_blank" style="text-decoration:none; color:#333;">${msg.file_name || 'ä¸‹è½½æ–‡ä»¶'}</a>
                                    </div>`;
                                }
                            }
                            if (msg.content) {
                                contentHtml += `<div>${msg.content}</div>`;
                            }

                            // æ‹¼æ¥æ°”æ³¡ HTML
                            if (msg.is_my_msg) {
                                html += `
                                    <div class="message-wrapper message-right" data-msg-id="${msg.id}">
                                        <div class="message-bubble">${contentHtml}</div>
                                        <div class="message-time">${msg.timestamp}</div>
                                    </div>`;
                            } else {
                                html += `
                                    <div class="message-wrapper message-left" data-msg-id="${msg.id}">
                                        <div class="message-info">${msg.sender}</div>
                                        <div class="message-bubble">${contentHtml}</div>
                                        <div class="message-time">${msg.timestamp}</div>
                                    </div>`;
                            }
                        });

                        // æ’å…¥åˆ°é¡¶éƒ¨
                        msgBox.insertAdjacentHTML('afterbegin', html);
                    }

                    if (data.has_more) {
                        btn.innerText = 'â–² ç‚¹å‡»åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯';
                        btn.style.pointerEvents = 'auto';
                    } else {
                        btn.innerText = 'å·²æ˜¾ç¤ºæ‰€æœ‰å†å²æ¶ˆæ¯';
                        btn.style.cursor = 'default';
                        setTimeout(() => btn.remove(), 1000);
                    }
                } else {
                    btn.innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                    btn.style.pointerEvents = 'auto';
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerText = 'ç½‘ç»œé”™è¯¯';
                btn.style.pointerEvents = 'auto';
            });
        }

        // ================== 6. å¼¹çª—ä¸èœå•é€»è¾‘ (ä¿æŒä¸å˜) ==================
        function toggleDropdown() {
            const menu = document.getElementById('plusMenu');
            if (menu) menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.sidebar-header') && document.getElementById('plusMenu')) {
                document.getElementById('plusMenu').style.display = 'none';
            }
        });

        // ç»‘å®šåˆ›å»º/åŠ å…¥æˆ¿é—´çš„è¡¨å•äº‹ä»¶
        const createForm = document.getElementById('createRoomForm');
        if (createForm) {
            createForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('c_name').value;
                const pwd = document.getElementById('c_pwd').value;
                const confirm = document.getElementById('c_confirm').value;

                if (pwd !== confirm) {
                    const err = document.getElementById('createError');
                    err.innerText = 'å¯†ç ä¸ä¸€è‡´';
                    err.style.display = 'block';
                    return;
                }
                fetch('{% url "create_room" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ name: name, password: pwd, confirm_password: confirm })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) window.location.href = '/chat/' + data.room_name + '/';
                    else {
                        const box = document.getElementById('createError');
                        box.innerText = data.error; box.style.display = 'block';
                    }
                });
            });
        }

        const joinForm = document.getElementById('joinRoomForm');
        if (joinForm) {
            joinForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('j_name').value;
                const pwd = document.getElementById('j_pwd').value;

                fetch('{% url "join_room" %}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ room_name: name, password: pwd })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) window.location.href = '/chat/' + data.room_name + '/';
                    else {
                        const box = document.getElementById('joinError');
                        box.innerText = data.error; box.style.display = 'block';
                    }
                });
            });
        }

        function openCreateModal() { document.getElementById('createRoomModal').style.display = 'flex'; }
        function openJoinModal() { document.getElementById('joinRoomModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
