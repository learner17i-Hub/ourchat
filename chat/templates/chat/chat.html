{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ active_room.name }}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* --- å·¦ä¾§ä¾§è¾¹æ  --- */
        .sidebar {
            width: 280px; background: #f5f7fa; border-right: 1px solid #ddd;
            display: flex; flex-direction: column;
        }

        .sidebar-header { padding: 20px; border-bottom: 1px solid #ddd; }
        .search-box {
            width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc;
            outline: none; background: white;
        }

        .room-list { flex: 1; overflow-y: auto; }

        .room-item {
            padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer;
            transition: background 0.2s; color: #333; text-decoration: none; display: block;
        }
        .room-item:hover { background: #e6e9ef; }

        /* é€‰ä¸­çŠ¶æ€ï¼šè“è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­— */
        .room-item.active { background: #0088cc; color: white; }
        .room-item.active .room-last-msg { color: #e0e0e0; }

        .room-name { font-weight: bold; font-size: 16px; margin-bottom: 5px; }
        .room-last-msg { font-size: 13px; color: #888; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}

        /* --- å³ä¾§èŠå¤©ä¸»åŒºåŸŸ --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background: white; }

        .chat-header {
            padding: 15px 20px; border-bottom: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
            background: white; z-index: 10;
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .header-info { font-size: 14px; color: #888; }
        .back-to-lobby { text-decoration: none; color: #0088cc; font-size: 14px; }

        /* æ¶ˆæ¯åˆ—è¡¨åŒº */
        .messages-box {
            flex: 1; padding: 20px; overflow-y: auto; background: #fff;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
        .message-wrapper { display: flex; flex-direction: column; max-width: 70%; }
        .message-info { font-size: 12px; color: #999; margin-bottom: 4px; }
        .message-bubble {
            padding: 10px 15px; border-radius: 10px; font-size: 15px; line-height: 1.5;
            position: relative; word-wrap: break-word;
            border: 2px solid #000; /* ä½ çš„è®¾è®¡å›¾é£æ ¼ï¼šé»‘è‰²è¾¹æ¡† */
        }
        .message-time { font-size: 11px; color: #aaa; text-align: right; margin-top: 5px; }

        /* åˆ«äººçš„æ¶ˆæ¯ (å·¦ä¾§) */
        .message-left { align-self: flex-start; }
        .message-left .message-bubble {
            background: white; color: #333;
            border-top-left-radius: 0; /* æ°”æ³¡å°–è§’ */
        }

        /* æˆ‘çš„æ¶ˆæ¯ (å³ä¾§) */
        .message-right { align-self: flex-end; align-items: flex-end; }
        .message-right .message-bubble {
            background: #00a8ff; color: white; /* ä½ çš„è®¾è®¡å›¾ï¼šè“è‰²èƒŒæ™¯ */
            border-top-right-radius: 0;
            border: 2px solid #000;
        }
        .message-right .message-info { text-align: right; display: none; /* è‡ªå·±å‘çš„æ¶ˆæ¯é€šå¸¸ä¸æ˜¾ç¤ºåå­— */ }

        /* --- åº•éƒ¨è¾“å…¥åŒº --- */
        .input-area {
            padding: 20px; border-top: 1px solid #eee; background: #f9f9f9;
            display: flex; align-items: center; gap: 10px;
        }
        .attach-btn { font-size: 24px; cursor: pointer; color: #666; }

        .msg-input {
            flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ccc;
            outline: none; font-size: 16px;
        }

        .send-btn {
            padding: 10px 25px; background: #00a8ff; color: white;
            border: 2px solid #000; border-radius: 8px; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        .send-btn:hover { background: #0088cc; }

    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <input type="text" class="search-box" placeholder="æœç´¢...">
        </div>

        <div class="room-list">
            {% for room in joined_rooms %}
            <a href="{% url 'chat_room' room.name %}"
               class="room-item {% if room.name == active_room.name %}active{% endif %}">
                <div class="room-name">{{ room.name }}</div>
                <div class="room-last-msg">
                    {% if room.messages.last %}
                        {{ room.messages.last.sender.username }}: {{ room.messages.last.content }}
                    {% else %}
                        æš‚æ— æ¶ˆæ¯
                    {% endif %}
                </div>
            </a>
            {% endfor %}

            <a href="{% url 'lobby' %}" class="room-item" style="color:#0088cc; text-align:center;">
                + æ·»åŠ /åˆ›å»ºæ–°èŠå¤©å®¤
            </a>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div>
                <span class="header-title">{{ active_room.name }}</span>
                <span class="header-info">({{ active_room.members.count }} æˆå‘˜)</span>
            </div>
            <a href="{% url 'lobby' %}" class="back-to-lobby">è¿”å›å¤§å…</a>
        </div>

        <div class="messages-box" id="msgBox">
            {% if has_more %}
                <div id="historyBtn" class="history-btn" onclick="loadHistory()">
                    â–² ç‚¹å‡»åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
                </div>
            {% endif %}

            {% for msg in messages %}
                {% if msg.sender == user %}
                    <div class="message-wrapper message-right" data-msg-id="{{ msg.id }}">
                        <div class="message-bubble">{{ msg.content }}</div>
                        <div class="message-time">{{ msg.timestamp|date:"H:i" }}</div>
                    </div>
                {% else %}
                    <div class="message-wrapper message-left" data-msg-id="{{ msg.id }}">
                        <div class="message-info">{{ msg.sender.username }}</div>
                        <div class="message-bubble">{{ msg.content }}</div>
                        <div class="message-time">{{ msg.timestamp|date:"H:i" }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="input-area">
            <div class="attach-btn">ğŸ“</div> <input type="text" class="msg-input" id="inputMsg" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleEnter(event)">
            <button class="send-btn" onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // ================== 1. åŸºç¡€å˜é‡ä¸åˆå§‹åŒ– ==================
        const msgBox = document.getElementById('msgBox');
        const inputMsg = document.getElementById('inputMsg');
        const roomId = "{{ active_room.id }}";

        // è·å–é¡µé¢ä¸Šå·²ç»å­˜åœ¨çš„æœ€åä¸€æ¡æ¶ˆæ¯çš„ID
        // æˆ‘ä»¬åˆ©ç”¨ Django æ¨¡æ¿åœ¨ HTML é‡ŒåŸ‹ä¸€ä¸ªéšè—çš„æ•°æ®ï¼Œæˆ–è€…ç›´æ¥ä» DOM è·å–
        // è¿™é‡Œæœ€ç®€å•çš„åšæ³•ï¼šé¡µé¢åŠ è½½æ—¶ï¼ŒæŠŠ lastMessageId è®¾ä¸ºå½“å‰æœ€åä¸€æ¡æ¶ˆæ¯çš„ID
        let lastMessageId = "{{ messages.last.id|default:0 }}";

        // è‡ªåŠ¨æ»šåˆ°åº•éƒ¨
        function scrollToBottom() { msgBox.scrollTop = msgBox.scrollHeight; }
        scrollToBottom();

        // ================== 2. è½®è¯¢ï¼šæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ¶ˆæ¯ ==================
        setInterval(fetchNewMessages, 2000);

        function fetchNewMessages() {
            // å‘é€ GET è¯·æ±‚ï¼Œå¸¦ä¸Š room_id å’Œ last_message_id
            fetch(`/api/get_messages/?room_id=${roomId}&last_message_id=${lastMessageId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages.length > 0) {
                    // å¦‚æœæœ‰æ–°æ¶ˆæ¯
                    data.messages.forEach(msg => {
                        appendMessage(msg);
                        // æ›´æ–° lastMessageIdï¼Œè¿™æ ·ä¸‹æ¬¡å°±åªæŸ¥è¿™ä¸€æ¡ä¹‹åçš„æ¶ˆæ¯äº†
                        lastMessageId = msg.id;
                    });
                    // æœ‰æ–°æ¶ˆæ¯æ‰æ»šåŠ¨
                    scrollToBottom();
                }
            })
            .catch(err => console.error("è½®è¯¢å‡ºé”™:", err)); // å®‰é™åœ°å¤±è´¥ï¼Œä¸è¦å¼¹çª—æ‰“æ‰°ç”¨æˆ·
        }

        // æŠŠæ¶ˆæ¯ç”»åœ¨ç•Œé¢ä¸Š
        function appendMessage(msg) {
            let html = '';
            if (msg.is_my_msg) {
                // æˆ‘çš„æ¶ˆæ¯ (å³è¾¹)
                html = `
                    <div class="message-wrapper message-right">
                        <div class="message-bubble">${msg.content}</div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>`;
            } else {
                // åˆ«äººçš„æ¶ˆæ¯ (å·¦è¾¹)
                html = `
                    <div class="message-wrapper message-left">
                        <div class="message-info">${msg.sender}</div>
                        <div class="message-bubble">${msg.content}</div>
                        <div class="message-time">${msg.timestamp}</div>
                    </div>`;
            }
            msgBox.insertAdjacentHTML('beforeend', html);
        }

        // ================== 3. å‘é€æ¶ˆæ¯é€»è¾‘ ==================
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        function sendMessage() {
            const content = inputMsg.value.trim();
            if (!content) return;

            fetch('{% url "send_message" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ room_id: roomId, content: content })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // å‘é€æˆåŠŸåï¼Œä¸éœ€è¦æ‰‹åŠ¨ appendMessage äº†ï¼
                    // å› ä¸ºæˆ‘ä»¬çš„è½®è¯¢æœºåˆ¶ä¼šåœ¨2ç§’å†…è‡ªåŠ¨æŠŠå®ƒæ‹‰å›æ¥ã€‚
                    // ä½†ä¸ºäº†ä½“éªŒæ›´â€œæé€Ÿâ€ï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨å…ˆç”»ä¸Šå»ï¼Œæˆ–è€…å°±ç­‰è½®è¯¢ã€‚
                    // ä¸ºäº†é˜²æ­¢æ¶ˆæ¯é‡å¤æ˜¾ç¤ºï¼ˆæ‰‹åŠ¨ç”»ä¸€æ¬¡ï¼Œè½®è¯¢åˆæ‹‰ä¸€æ¬¡ï¼‰ï¼Œ
                    // æœ€ç®€å•çš„ç­–ç•¥æ˜¯ï¼šå‘é€æˆåŠŸåï¼Œç›´æ¥æ›´æ–° lastMessageId ä¸ºåç«¯è¿”å›çš„ ID (å¦‚æœåç«¯è¿”å›äº†çš„è¯)
                    // æˆ–è€…ï¼šå‘é€æˆåŠŸåä¸æ¸…ç©º lastMessageIdï¼Œè®©è½®è¯¢å»å¤„ç†æ˜¾ç¤ºã€‚

                    // è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ï¼šä¸ºäº†å³æ—¶åé¦ˆï¼Œæ‰‹åŠ¨ç”»å‡ºâ€œæˆ‘çš„æ¶ˆæ¯â€ï¼Œ
                    // ä½†è¿™é‡Œæœ‰ä¸ªå°å‘ï¼šå¦‚æœè½®è¯¢å¿«äºæ‰‹åŠ¨ç”»ï¼Œæˆ–è€…æ‰‹åŠ¨ç”»äº†è½®è¯¢åˆæ‹‰åˆ°äº†ï¼Œå°±ä¼šé‡å¤ã€‚
                    // â­ï¸ æœ€ä½³å®è·µï¼ˆè½®è¯¢æ¨¡å¼ä¸‹ï¼‰ï¼š
                    // å‘é€æˆåŠŸå -> æ¸…ç©ºè¾“å…¥æ¡† -> æ‰‹åŠ¨è¿½åŠ  -> å¹¶ä¸´æ—¶æ ‡è®°è¿™æ¡æ¶ˆæ¯IDï¼Œé˜²æ­¢è½®è¯¢é‡å¤ã€‚
                    // ä½†ä¸ºäº†ä»£ç ç®€å•ï¼Œæˆ‘ä»¬è¿™æ ·åšï¼š
                    // å‘é€æˆåŠŸå -> æ¸…ç©ºè¾“å…¥æ¡† -> è¿™é‡Œä¸æ‰‹åŠ¨è¿½åŠ  HTMLï¼Œè€Œæ˜¯ç«‹å³è°ƒç”¨ä¸€æ¬¡ fetchNewMessages()ï¼

                    inputMsg.value = '';
                    fetchNewMessages(); // ç«‹å³è§¦å‘ä¸€æ¬¡æ‹‰å–ï¼Œä¸ç”¨ç­‰2ç§’
                } else {
                    alert('å‘é€å¤±è´¥: ' + data.error);
                }
            });
        }

        // ================== 4. å¼¹çª—ä¸èœå•é€»è¾‘ (ä¿æŒä¸å˜) ==================
        function toggleDropdown() {
            const menu = document.getElementById('plusMenu');
            menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.sidebar-header')) {
                document.getElementById('plusMenu').style.display = 'none';
            }
        });

        function openCreateModal() { document.getElementById('createRoomModal').style.display = 'flex'; }
        function openJoinModal() { document.getElementById('joinRoomModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // åˆ›å»ºè¡¨å•æäº¤
        document.getElementById('createRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('c_name').value;
            const pwd = document.getElementById('c_pwd').value;
            const confirm = document.getElementById('c_confirm').value;

            if (pwd !== confirm) {
                document.getElementById('createError').innerText = 'å¯†ç ä¸ä¸€è‡´';
                document.getElementById('createError').style.display = 'block';
                return;
            }
            // ... AJAX create logic ...
            fetch('{% url "create_room" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ name: name, password: pwd, confirm_password: confirm })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) window.location.href = '/chat/' + data.room_name + '/';
                else {
                    const box = document.getElementById('createError');
                    box.innerText = data.error; box.style.display = 'block';
                }
            });
        });

        // åŠ å…¥è¡¨å•æäº¤
        document.getElementById('joinRoomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('j_name').value;
            const pwd = document.getElementById('j_pwd').value;

            // ... AJAX join logic ...
            fetch('{% url "join_room" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ room_name: name, password: pwd })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) window.location.href = '/chat/' + data.room_name + '/';
                else {
                    const box = document.getElementById('joinError');
                    box.innerText = data.error; box.style.display = 'block';
                }
            });
        });

        function loadHistory() {
            // è·å–å½“å‰æ˜¾ç¤ºçš„æœ€ä¸Šé¢ä¸€æ¡æ¶ˆæ¯çš„ ID
            const firstMsgEl = document.querySelector('.message-wrapper');
            if (!firstMsgEl) return;

            const firstId = firstMsgEl.getAttribute('data-msg-id');
            const btn = document.getElementById('historyBtn');

            // 1. æ”¹å˜æŒ‰é’®çŠ¶æ€ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            const originalText = btn.innerText;
            btn.innerText = 'åŠ è½½ä¸­...';
            btn.style.pointerEvents = 'none'; // æš‚æ—¶ç¦ç”¨ç‚¹å‡»

            // 2. å‘èµ·è¯·æ±‚
            fetch(`/api/get_history/?room_id=${roomId}&first_msg_id=${firstId}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // å¦‚æœæœ‰æ¶ˆæ¯è¿”å›ï¼Œæ’å…¥åˆ° DOM
                    if (data.messages.length > 0) {
                        let html = '';
                        data.messages.forEach(msg => {
                            // æ ¹æ®æ˜¯å¦æ˜¯è‡ªå·±çš„æ¶ˆæ¯æ‹¼æ¥ HTML
                            if (msg.is_my_msg) {
                                html += `
                                    <div class="message-wrapper message-right" data-msg-id="${msg.id}">
                                        <div class="message-bubble">${msg.content}</div>
                                        <div class="message-time">${msg.timestamp}</div>
                                    </div>`;
                            } else {
                                html += `
                                    <div class="message-wrapper message-left" data-msg-id="${msg.id}">
                                        <div class="message-info">${msg.sender}</div>
                                        <div class="message-bubble">${msg.content}</div>
                                        <div class="message-time">${msg.timestamp}</div>
                                    </div>`;
                            }
                        });

                        // æ’å…¥åˆ°æŒ‰é’®çš„åé¢
                        btn.insertAdjacentHTML('afterend', html);
                    }

                    // 3. æ ¹æ®åç«¯ has_more å­—æ®µå†³å®šæŒ‰é’®å»ç•™
                    if (data.has_more) {
                        btn.innerText = 'â–² ç‚¹å‡»åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯';
                        btn.style.pointerEvents = 'auto'; // æ¢å¤ç‚¹å‡»
                    } else {
                        btn.innerText = 'å·²æ˜¾ç¤ºæ‰€æœ‰å†å²æ¶ˆæ¯';
                        btn.style.cursor = 'default';
                        // 1ç§’åæ·¡å‡ºç§»é™¤
                        setTimeout(() => btn.remove(), 1000);
                    }
                } else {
                    btn.innerText = 'åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•';
                    btn.style.pointerEvents = 'auto';
                }
            })
            .catch(err => {
                console.error(err);
                btn.innerText = 'ç½‘ç»œé”™è¯¯';
                btn.style.pointerEvents = 'auto';
            });
        }
    </script>
</body>
</html>