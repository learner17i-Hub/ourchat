{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è®¾ç½® - {{ room.name }}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; display: flex; flex-direction: column; min-height: 100vh; margin: 0; }
        .navbar { padding: 20px 40px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .back-link { text-decoration: none; color: #333; font-weight: bold; }

        .main-box {
            background: white; width: 100%; max-width: 800px; /* åŠ å®½ä¸€ç‚¹ä»¥å®¹çº³å›¾è¡¨ */
            margin: 40px auto; padding: 40px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        .section-title { font-size: 24px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .form-group { margin-bottom: 20px; }
        .label { display: block; margin-bottom: 8px; font-weight: bold; color: #555; }
        .input-field { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; outline: none; transition: 0.3s; box-sizing: border-box; }
        .input-field:focus { border-color: #333; }

        .btn-save { background: #333; color: white; padding: 12px 30px; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; width: 100%; font-weight: bold; }
        .btn-save:hover { background: #555; }

        .member-link-card { margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e0e0e0; cursor: pointer; text-decoration: none; color: inherit; transition: 0.2s; }
        .member-link-card:hover { background: #eef2ff; border-color: #667eea; }
        .icon-circle { width: 50px; height: 50px; background: #667eea; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; }

        .alert { padding: 15px; background: #d4edda; color: #155724; border-radius: 8px; margin-bottom: 20px; }
        .alert-error { background: #f8d7da; color: #721c24; }

        /* --- æ–°å¢ï¼šå›¾è¡¨å®¹å™¨æ ·å¼ --- */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* ä¸¤åˆ—å¸ƒå±€ */
            gap: 20px;
            margin-top: 40px;
        }
        .chart-card {
            background: #fff; border: 1px solid #eee;
            border-radius: 15px; padding: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .chart-title {
            text-align: center; font-weight: bold; margin-bottom: 15px; color: #666; font-size: 14px;
        }

        /* å“åº”å¼ï¼šæ‰‹æœºç«¯å˜æˆå•åˆ— */
        @media (max-width: 600px) {
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="navbar">
        <a href="{% url 'manage_dashboard' %}" class="back-link">â† è¿”å›æˆ¿é—´åˆ—è¡¨</a>
    </div>

    <div class="main-box">
        <h2 class="section-title">æˆ¿é—´è®¾ç½®</h2>

        {% if messages %}
            {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-error{% endif %}">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label class="label">æˆ¿é—´åç§°</label>
                <input type="text" name="name" class="input-field" value="{{ room.name }}" required>
            </div>
            <div class="form-group">
                <label class="label">æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸è®¾é˜²ï¼‰</label>
                <input type="password" name="password" class="input-field" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
            </div>
            <div class="form-group">
                <label class="label">ç¡®è®¤å¯†ç </label>
                <input type="password" name="confirm_password" class="input-field" placeholder="å†æ¬¡è¾“å…¥">
            </div>
            <button type="submit" class="btn-save">ä¿å­˜æ›´æ”¹</button>
        </form>

        <div class="charts-container">
            <div class="chart-card">
                <div class="chart-title">ğŸ† 24å°æ—¶æœ€æ´»è·ƒç”¨æˆ·</div>
                <canvas id="userChart"></canvas>
            </div>
            <div class="chart-card">
                <div class="chart-title">â±ï¸ 24å°æ—¶æ´»è·ƒæ—¶é—´æ®µ</div>
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <a href="{% url 'manage_members' room.name %}" class="member-link-card">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="icon-circle">ğŸ‘¥</div>
                <div>
                    <div style="font-weight: bold; font-size: 18px;">æˆå‘˜ç®¡ç†</div>
                    <div style="color: #666; font-size: 14px;">æŸ¥çœ‹åˆ—è¡¨ã€ç§»é™¤æˆå‘˜</div>
                </div>
            </div>
            <div style="font-size: 24px; color: #ccc;">â€º</div>
        </a>


        <a href="{% url 'manage_messages' room.name %}" class="member-link-card" style="margin-top: 15px;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div class="icon-circle" style="background: #f6ad55;">ğŸ’¬</div>
                <div>
                    <div style="font-weight: bold; font-size: 18px;">æ¶ˆæ¯ç®¡ç†</div>
                    <div style="color: #666; font-size: 14px;">æŸ¥çœ‹åˆ—è¡¨ã€æ‰¹é‡åˆ é™¤è¿è§„æ¶ˆæ¯</div>
                </div>
            </div>
            <div style="font-size: 24px; color: #ccc;">â€º</div>
        </a>
        </div>
    </div>

    <script>
        // 1. è·å–åç«¯ä¼ æ¥çš„æ•°æ® (Djangoæ¨¡æ¿è¯­æ³•)
        const userLabels = JSON.parse('{{ user_labels|safe }}');
        const userData = JSON.parse('{{ user_data|safe }}');

        const timeLabels = JSON.parse('{{ time_labels|safe }}');
        const timeData = JSON.parse('{{ time_data|safe }}');

        // 2. ç»˜åˆ¶ç”¨æˆ·å›¾è¡¨ (Bar Chart)
        const ctxUser = document.getElementById('userChart').getContext('2d');
        new Chart(ctxUser, {
            type: 'bar',
            data: {
                labels: userLabels,
                datasets: [{
                    label: 'å‘è¨€æ•°',
                    data: userData,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)', // ä½ çš„ä¸»é¢˜è“ç´«è‰²
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });

        // 3. ç»˜åˆ¶æ—¶æ®µå›¾è¡¨ (Bar Chart)
        const ctxTime = document.getElementById('timeChart').getContext('2d');
        new Chart(ctxTime, {
            type: 'bar', // è¿™é‡Œç”¨äº†æ¡å½¢å›¾ï¼Œä¹Ÿå¯ä»¥æ”¹æˆ 'line' æŠ˜çº¿å›¾
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'æ¶ˆæ¯æ•°',
                    data: timeData,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)', // æ©™è‰²
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    </script>
</body>
</html>